name: Update Documentation on Pull Request Comment

on:
  issue_comment:
    types: [created]

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: PR comment
    if: ${{ github.event.issue.pull_request }} && startsWith(github.event.comment.body, 'Documentation ')
 
    steps:
      - name: Get PR branch
        uses: xt0rted/pull-request-comment-branch@v1
        id: comment-branch

      - name: Checkout PR branch
        uses: actions/checkout@v3
        with:
          ref: ${{ steps.comment-branch.outputs.head_ref }}

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.10'

      - name: Insall dependencies
        run: pip install -r requirements.txt

      - name: Get file path name and comment
        id: extract
        run: |
          COMMENT="${{ github.event.comment.body }}"
          FILE_PATH=$(echo "$COMMENT" | grep -oP '(?<=Documentation\s)[^:]*')
          COMMENT_BODY=$(echo "$COMMENT" | sed 's/^[^:}*: //')
          echo "file_path=$FILE_PATH" >> $GITHUB_OUTPUT
          echo "comment_body=$COMMENT_BODY" >> $GITHUB_OUTPUT

      - name: Update Documentation
        run: |
          python update_app.py --file "$FILE_PATH" --comment "$COMMENT_BODY"
        env:
          FILE_PATH: ${{ steps.extract.outputs.file_path }}
          COMMENT_BODY: ${{ steps.extract.outputs.comment_body }}

      - name: Commit and push changes
        run: |
          git config --global user.email "github-actions@github.com"
          git config --global user.name "github-actions"
          git add "$FILE_PATH"
          git commit -m "Update documentation for $FILE_PATH" 
          git pull --rebase
          git push
        env:
          FILE_PATH: ${{ steps.extract.outputs.file_path }}
